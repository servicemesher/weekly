---
author: "Rinor Maloku"
translator: "loverto"
reviewer: ["haiker2011","rootsongjc"]
title: "ä½¿ç”¨Istioæ‰“é€ å¾®æœåŠ¡ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰"
description: "ä½¿ç”¨Istioæ‰“é€ å¾®æœåŠ¡ï¼ˆç¬¬1éƒ¨åˆ†ï¼‰"
categories: "translation"
tags: ["istio","microservices","kubernetes","vs","tracing","monitor"]
date: 2019-02-12
---

**Istio** æ˜¯ä¸€ä¸ªç”±Googleï¼ŒIBMå’ŒLyftå›¢é˜Ÿåˆä½œå¼€å‘çš„å¼€æºé¡¹ç›®ï¼Œå®ƒæä¾›äº†åŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºå¤æ‚æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œä»…ä¸¾å‡ ä¾‹ï¼š

- **æµé‡ç®¡ç†** ï¼šè¶…æ—¶ï¼Œé‡è¯•ï¼Œè´Ÿè½½å‡è¡¡ï¼Œ
- **å®‰å…¨æ€§ï¼š** æœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯å’Œæˆæƒï¼Œ
- **å¯è§‚å¯Ÿæ€§ï¼š** è·Ÿè¸ªï¼Œç›‘æ§å’Œè®°å½•ã€‚

æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥åœ¨åº”ç”¨ç¨‹åºå±‚ä¸­è§£å†³ï¼Œä½†æ˜¯æ‚¨çš„æœåŠ¡ä¸å†æ˜¯â€œå¾®å‹â€ï¼Œç›¸å¯¹äºæä¾›ä¸šåŠ¡ä»·å€¼çš„èµ„æºï¼Œå®ç°è¿™äº›çš„æ‰€æœ‰é¢å¤–å·¥ä½œéƒ½æ˜¯å…¬å¸èµ„æºçš„å‹åŠ›ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼š

> PMï¼šæ·»åŠ åé¦ˆåŠŸèƒ½éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

> å¼€å‘ï¼šä¸¤ä¸ªå†²åˆºï¼ˆæ•æ·å¼€å‘ä¸­çš„æœ¯è¯­ï¼Œä¸€èˆ¬ä¸€ä¸ªå†²åˆºå‘¨æœŸ30å¤©ï¼‰ã€‚

> PMï¼šä»€ä¹ˆ......ï¼Ÿ é‚£åªæ˜¯ä¸€ä¸ªCRUDï¼

> å¼€å‘ï¼šåˆ›å»ºCRUDå¾ˆå®¹æ˜“ï¼Œä½†æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·å’ŒæœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚è€Œä¸”ç”±äºç½‘ç»œä¸å¯é ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯å®æ–½é‡è¯•å’Œç†”æ–­å™¨ï¼Œå¹¶ç¡®ä¿æˆ‘ä»¬ä¸ä¼šå ç”¨æ•´ä¸ªç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦Timeoutå’ŒBulkheadsï¼Œå¦å¤–è¿˜è¦æ£€æµ‹æˆ‘ä»¬éœ€è¦ç›‘æ§çš„é—®é¢˜ï¼Œè·Ÿè¸ª\[... \]

> PMï¼šé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒæ”¾åœ¨äº§å“æœåŠ¡ä¸­å§ã€‚å“å‘€ï¼

ä½ æ˜ç™½äº†ï¼Œå¿…é¡»æ»¡è¶³æ‰€æœ‰å½¢å¼æ‰å¯ä»¥ä¸ºæˆ‘ä»¬æ·»åŠ ä¸€é¡¹å·¨å¤§çš„æœåŠ¡ï¼ˆæœ‰å¾ˆå¤šä¸æ˜¯ä¸šåŠ¡åŠŸèƒ½çš„ä»£ç ï¼‰ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºIstioå¦‚ä½•ä»æˆ‘ä»¬çš„æœåŠ¡ä¸­åˆ é™¤æ‰€æœ‰ä¸Šè¿°äº¤å‰é—®é¢˜ã€‚

![å›¾1.å¾®æœåŠ¡çš„å½¢å¼æ„æˆ](https://ws1.sinaimg.cn/large/61411417ly1g0exu1x75cj20ai081t8l.jpg)

**æ³¨æ„**ï¼š æœ¬æ–‡å‡è®¾æ‚¨å…·æœ‰Kubernetesçš„çŸ¥è¯†ã€‚å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œæˆ‘å»ºè®®æ‚¨é˜…è¯» [æˆ‘å¯¹Kubernetesçš„ä»‹ç»](https://medium.freecodecamp.org/learn-kubernetes-in-under-3-hours-a-detailed-guide-to-orchestrating-containers-114ff420e882)ï¼Œç„¶åç»§ç»­é˜…è¯»æœ¬æ–‡ã€‚

### å…³äºIstio

åœ¨æ²¡æœ‰Istioçš„ä¸–ç•Œä¸­ï¼Œä¸€ä¸ªæœåŠ¡å‘å¦ä¸€ä¸ªæœåŠ¡ç›´æ¥å‘å‡ºè¯·æ±‚ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿæ•…éšœçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡éœ€è¦é€šè¿‡é‡è¯•ï¼Œè¶…æ—¶ï¼Œæ‰“å¼€ç†”æ–­å™¨ç­‰æ¥å¤„ç†å®ƒã€‚

![å›¾2. Kubernetesä¸­çš„ç½‘ç»œæµé‡](https://ws1.sinaimg.cn/large/61411417ly1g0exu1eu2vj20m8054dg4.jpg)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒIstioé€šè¿‡ä¸æœåŠ¡å®Œå…¨åˆ†ç¦»ï¼Œå¹¶é€šè¿‡æ‹¦æˆªæ‰€æœ‰ç½‘ç»œé€šä¿¡æ¥æä¾›ä¸€ç§å·§å¦™çš„è§£å†³æ–¹æ¡ˆã€‚è¿™æ ·åšå¯ä»¥å®ç°ï¼š

- **Fault Tolerance** â€Š\- ä½¿ç”¨å“åº”çŠ¶æ€ä»£ç ï¼Œå®ƒå¯ä»¥åœ¨è¯·æ±‚å¤±è´¥å¹¶é‡è¯•æ—¶ç†è§£ã€‚
- **Canary Rollouts** â€Š\- ä»…å°†æŒ‡å®šç™¾åˆ†æ¯”çš„è¯·æ±‚è½¬å‘åˆ°æ–°ç‰ˆæœ¬çš„æœåŠ¡ã€‚
- **ç›‘æ§å’ŒæŒ‡æ ‡** â€Š\- æœåŠ¡å“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚
- **è·Ÿè¸ªå’Œå¯è§‚å¯Ÿæ€§** â€Š\- å®ƒåœ¨æ¯ä¸ªè¯·æ±‚ä¸­æ·»åŠ ç‰¹æ®Šheaderï¼Œå¹¶åœ¨é›†ç¾¤ä¸­è·Ÿè¸ªå®ƒä»¬ã€‚
- **å®‰å…¨æ€§** â€Š\- æå–JWTä»¤ç‰Œå¹¶å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚

ä»…ä¸¾å‡ ä¾‹ï¼ˆä»…ä¸¾å‡ ä¾‹ï¼‰ï¼Œè®©æ‚¨æ„Ÿå…´è¶£ï¼ æˆ‘ä»¬æ¥çœ‹ä¸€äº›æŠ€æœ¯ç»†èŠ‚å§ï¼

### Istioçš„æ¶æ„

Istioæ‹¦æˆªæ‰€æœ‰ç½‘ç»œæµé‡ï¼Œå¹¶é€šè¿‡åœ¨æ¯ä¸ªpodä¸­æ³¨å…¥æ™ºèƒ½ä»£ç†ä½œä¸ºsidecaræ¥åº”ç”¨ä¸€ç»„è§„åˆ™ã€‚å¯ç”¨æ‰€æœ‰åŠŸèƒ½çš„ä»£ç†åŒ…æ‹¬ **æ•°æ®å¹³é¢**ï¼Œ å¹¶ä¸”è¿™äº›ä»£ç†å¯ç”±**æ§åˆ¶å¹³é¢** åŠ¨æ€é…ç½®ã€‚

### æ•°æ®å¹³é¢

æ³¨å…¥çš„ä»£ç†ä½¿Istioèƒ½å¤Ÿè½»æ¾æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é‡è¯•å’Œç†”æ–­å™¨åŠŸèƒ½ã€‚

![å›¾3.Envoyå¦‚ä½•å®ç°Retrieså’ŒCircuitBreaking](https://ws1.sinaimg.cn/large/61411417ly1g0exu34d0gg20m808a1kx.gif)



æ€»ç»“ä¸€ä¸‹ï¼š

1. Envoyå°†è¯·æ±‚å‘é€åˆ°æœåŠ¡Bçš„ç¬¬ä¸€ä¸ªå®ä¾‹ï¼Œä½†å®ƒå¤±è´¥äº†ã€‚
2. Envoy sidecaré‡è¯•ã€‚ï¼ˆ1ï¼‰
3. è¿”å›å¯¹è°ƒç”¨ä»£ç†çš„å¤±è´¥è¯·æ±‚ã€‚
4. è¿™å°†æ‰“å¼€ç†”æ–­å™¨å¹¶åœ¨åç»­è¯·æ±‚ä¸­è°ƒç”¨ä¸‹ä¸€ä¸ªæœåŠ¡ã€‚ï¼ˆ2ï¼‰

è¿™æ„å‘³ç€æ‚¨ä¸å¿…ä½¿ç”¨å¦ä¸€ä¸ªé‡è¯•åº“ï¼Œæ‚¨ä¸å¿…åœ¨ç¼–ç¨‹è¯­è¨€Xï¼ŒYæˆ–Zä¸­å¼€å‘è‡ªå·±çš„Circuit Breakingå’ŒService Discoveryå®ç°ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¼€ç®±å³ç”¨çš„ã€‚è¿™äº›åŠŸèƒ½éƒ½æ˜¯é€šè¿‡Istioæ¥å®ç°ï¼Œä½ ä¸éœ€è¦æ›´æ”¹ä»£ç ã€‚

å¾ˆå¥½ï¼ ç°åœ¨ä½ æƒ³åŠ å…¥Istioçš„èˆªè¡Œï¼Œä½†ä½ ä»ç„¶æœ‰ä¸€äº›ç–‘è™‘ï¼Œä¸€äº›æ‚¬è€Œæœªå†³çš„é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆï¼Œä½ å¯¹å®ƒæŒæ€€ç–‘æ€åº¦ï¼Œå› ä¸ºå®ƒæ€»æ˜¯æœ€ç»ˆæˆä¸ºä¸€åˆ€åˆ‡çš„æ— è§£æ–¹æ¡ˆï¼

ä½ æœ€ç»ˆä½å£°è¯´äº†è¿™ä¸ªé—®é¢˜ï¼šâ€œè¿™æ˜¯å¯é…ç½®çš„å—ï¼Ÿâ€

æ¬¢è¿æˆ‘çš„æœ‹å‹æ¥å·¡èˆªï¼Œæˆ‘ä»¬å°†ä¸ºå¤§å®¶ä»‹ç»ä¸€ä¸‹æ§åˆ¶å¹³é¢ã€‚

### æ§åˆ¶å¹³é¢

ç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼š **Pilot**ã€ **Mixer** å’Œ **Citadel**ï¼Œå®ƒä»¬ç»„åˆä½¿ç”¨Envoysæ¥è·¯ç”±æµé‡ï¼Œå®æ–½ç­–ç•¥å’Œæ”¶é›†é¥æµ‹æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![å›¾4.ä¸æ•°æ®å¹³é¢ç›¸å…³çš„æ§åˆ¶å¹³é¢](https://ws1.sinaimg.cn/large/61411417ly1g0exu2b2mqj20m80eogn9.jpg)

Envoyï¼ˆå³æ•°æ®å¹³é¢ï¼‰ä½¿ç”¨ç”±Istioå®šä¹‰çš„ [Kubernetesè‡ªå®šä¹‰èµ„æºå®šä¹‰](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) è¿›è¡Œé…ç½®ã€‚è¿™æ„å‘³ç€å¯¹ä½ è€Œè¨€ï¼Œå®ƒåªæ˜¯å¦ä¸€ä¸ªå…·æœ‰ç†Ÿæ‚‰è¯­æ³•çš„Kubernetesèµ„æºã€‚åˆ›å»ºåå°†ç”±**æ§åˆ¶å¹³é¢**è·å–ï¼Œå¹¶å°†å…¶åº”ç”¨äºEnvoyã€‚

### æœåŠ¡ä¸Istioçš„å…³ç³»

æˆ‘ä»¬æè¿°äº†Istioä¸æˆ‘ä»¬æœåŠ¡çš„å…³ç³»ï¼Œä½†æˆ‘ä»¬åè¿‡æ¥æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æœåŠ¡ä¸Istioçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

å¦ç‡åœ°è¯´ï¼Œæˆ‘ä»¬çš„æœåŠ¡å¯¹Istioçš„å­˜åœ¨æœ‰ç€å°½å¯èƒ½å¤šçš„äº†è§£ï¼Œå°±åƒé±¼å¯¹æ°´ä¸€æ ·ï¼Œä»–ä»¬ä¼šé—®è‡ªå·±â€œè¿™åˆ°åº•æ˜¯ä»€ä¹ˆæ°´ï¼Ÿâ€ã€‚

![Victoria Dimitrakopoulos](https://ws1.sinaimg.cn/large/61411417ly1g0exu1l39rj20m809tqd9.jpg)

è¿™æ„å‘³ç€æ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªå·¥ä½œé›†ç¾¤ï¼Œåœ¨éƒ¨ç½²äº†Istioçš„ç»„ä»¶åï¼Œå…¶ä¸­çš„æœåŠ¡å°†ç»§ç»­å·¥ä½œï¼Œå¹¶ä¸”ä»¥ç›¸åŒçš„æ–¹å¼ï¼Œæ‚¨å¯ä»¥åˆ é™¤ç»„ä»¶ï¼Œä¸€åˆ‡éƒ½ä¼šå¾ˆå¥½ã€‚å¯ä»¥ç†è§£çš„æ˜¯ï¼Œæ‚¨å°†å¤±å»Istioæä¾›çš„åŠŸèƒ½ã€‚

æˆ‘ä»¬å·²ç»æœ‰è¶³å¤Ÿçš„ç†è®ºï¼Œä¸‹é¢è®©æˆ‘ä»¬æŠŠè¿™äº›ç†è®ºä»˜è¯¸å®è·µï¼

### Istioå®è·µ

Istioè‡³å°‘éœ€è¦ä¸€ä¸ªå…·æœ‰4ä¸ªvCPUå’Œ8 GB RAMçš„Kubernetesé›†ç¾¤ã€‚è¦å¿«é€Ÿè®¾ç½®é›†ç¾¤å¹¶è·Ÿè¿›æœ¬æ–‡ï¼Œæˆ‘å»ºè®®ä½¿ç”¨Googleäº‘ç«¯å¹³å°ï¼Œå®ƒä¸ºæ–°ç”¨æˆ·æä¾› [300ç¾å…ƒçš„å…è´¹è¯•ç”¨ç‰ˆ](https://console.developers.google.com/billing/freetrial?hl=en) ã€‚

ä½¿ç”¨Kuberneteså‘½ä»¤è¡Œå·¥å…·åˆ›å»ºé›†ç¾¤å¹¶é…ç½®è®¿é—®åï¼Œæˆ‘ä»¬å·²å‡†å¤‡å¥½ä½¿ç”¨Helm Packageç®¡ç†å™¨å®‰è£…Istioã€‚

### å®‰è£…Helm

æŒ‰ç…§[å®˜æ–¹æ–‡æ¡£](https://docs.helm.sh/using_helm/#installing-the-helm-client)ä¸­çš„è¯´æ˜åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šå®‰è£…Helmå®¢æˆ·ç«¯ ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­ä½¿ç”¨å®ƒæ¥ç”ŸæˆIstioå®‰è£…æ¨¡æ¿ã€‚

### å®‰è£…Istio

ä»[æœ€æ–°ç‰ˆæœ¬](https://github.com/istio/istio/releases/tag/1.0.5)ä¸‹è½½Istioçš„èµ„æºï¼Œå°†å†…å®¹æå–åˆ°ä¸€ä¸ªæˆ‘ä»¬å°†ç§°ä¹‹ä¸ºçš„ç›®å½•ä¸­`[istio-resources]` ã€‚

è¦è½»æ¾è¯†åˆ«Istioèµ„æº `istio-system`ï¼Œè¯·åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºå‘½åç©ºé—´ ï¼š

```bash
$ kubectl create namespace istio-system
```

ç„¶åè¿›å…¥åˆ° `[istio-resources]` ç›®å½•å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆå®‰è£… ï¼š

```bash
$ helm template install/kubernetes/helm/istio \
 --set global.mtls.enabled = false \
 --set tracing.enabled = true \
 --set kiali.enabled = true \
 --set grafana.enabled = true \
 --namespace istio-system > istio.yaml
```

ä¸Šé¢çš„å‘½ä»¤å°†Istioçš„æ ¸å¿ƒç»„ä»¶è¾“å‡ºåˆ°æ–‡ä»¶ `istio.yaml` ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‚æ•°è‡ªå®šä¹‰æ¨¡æ¿ï¼š

- **global.mtls.enabled** è®¾ç½®ä¸ºfalseä»¥ä¿æŒå¼•å…¥çš„é‡ç‚¹ã€‚
- **tracing.enabled** å…è®¸ä½¿ç”¨jaegerè·Ÿè¸ªè¯·æ±‚ã€‚
- **kiali.enabled** åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸­å®‰è£…Kialiä»¥å®ç°æœåŠ¡å’Œæµé‡çš„å¯è§†åŒ–
- **grafana.enabled** å®‰è£…Grafanaï¼Œä¸ºäº†æ”¶é›†æŒ‡æ ‡çš„å¯è§†åŒ–ã€‚

é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åº”ç”¨ç”Ÿæˆçš„èµ„æº

```bash
$ kubectl apply -f istio.yaml
```

è¿™æ ‡å¿—ç€æˆ‘ä»¬é›†ç¾¤ä¸­Istioå®‰è£…çš„å®Œæˆï¼ç­‰åˆ°`istio-system`å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰podéƒ½å¤„äºRunningæˆ–CompletedçŠ¶æ€ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ kubectl get pods -n istio-system
```

ç°åœ¨æˆ‘ä»¬å·²å‡†å¤‡å¥½ç»§ç»­ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å¯åŠ¨å¹¶è¿è¡Œç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚

### Sentiment Analysisåº”ç”¨æ¶æ„

æˆ‘ä»¬å°†ä½¿ç”¨[Kubernetesç®€ä»‹æ–‡ç« ](https://medium.freecodecamp.org/learn-kubernetes-in-under-3-hours-a-detailed-guide-to-orchestrating-containers-114ff420e882)ä¸­ä½¿ç”¨çš„ç›¸åŒå¾®æœåŠ¡åº”ç”¨ç¨‹åºï¼Œå®ƒè¶³ä»¥åœ¨å®è·µä¸­å±•ç¤ºIstioçš„åŠŸèƒ½ã€‚

è¯¥åº”ç”¨ç¨‹åºç”±å››ä¸ªå¾®æœåŠ¡ç»„æˆï¼š

- **SA\-FrontendæœåŠ¡** ï¼šæä¾›å‰ç«¯Reactjsåº”ç”¨ç¨‹åºã€‚
- **SA\-WebAppæœåŠ¡** ï¼šå¤„ç†å¯¹Sentiment Analysisçš„è¯·æ±‚ã€‚
- **SA\-LogicæœåŠ¡** ï¼šæ‰§è¡Œsentiment Analysisã€‚
- **SAåé¦ˆæœåŠ¡** ï¼šæ¥æ”¶ç”¨æˆ·å…³äºåˆ†æå‡†ç¡®æ€§çš„åé¦ˆã€‚

![å›¾6æƒ…æ„Ÿåˆ†æå¾®æœåŠ¡](https://ws1.sinaimg.cn/large/61411417ly1g0exu2q2ppj20m80apmxy.jpg)

åœ¨å›¾6ä¸­ï¼Œé™¤äº†æœåŠ¡ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°Ingress Controlleråœ¨Kubernetesä¸­å°†ä¼ å…¥çš„è¯·æ±‚è·¯ç”±åˆ°é€‚å½“çš„æœåŠ¡ï¼ŒIstioä½¿ç”¨äº†ä¸€ä¸ªåä¸ºIngress Gatewayçš„ç±»ä¼¼æ¦‚å¿µï¼Œå°†åœ¨æœ¬æ–‡çš„åç»­éƒ¨åˆ†ä¸­ä»‹ç»ã€‚

### ä½¿ç”¨Istio Proxiesè¿è¡Œåº”ç”¨ç¨‹åº

è¦è·Ÿè¿›æœ¬æ–‡ï¼Œè¯·å…‹éš†å­˜å‚¨åº“istio\-masteryï¼ˆ [https://github.com/rinormaloku/istio\-mastery](https://github.com/rinormaloku/istio-mastery) ï¼‰ï¼Œå…¶ä¸­åŒ…å«Kuberneteså’ŒIstioçš„åº”ç”¨ç¨‹åºå’Œæ¸…å•ã€‚

#### Sidecar Injection

æ³¨å…¥æ˜¯ **è‡ªåŠ¨** æˆ– **æ‰‹åŠ¨** å®Œæˆçš„ ã€‚è¦å¯ç”¨è‡ªåŠ¨sidecaræ³¨å…¥ï¼Œæˆ‘ä»¬éœ€è¦ `istio-injection=enabled` é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ æ¥æ ‡è®°å‘½åç©ºé—´ ï¼š

```bash
$ kubectl label namespace default istio-injection=enabled
namespace/default labeled
```

ä»ç°åœ¨å¼€å§‹ï¼Œéƒ¨ç½²åˆ°é»˜è®¤å‘½åç©ºé—´çš„æ¯ä¸ªpodéƒ½å°†è·å¾—æ³¨å…¥çš„sidecarã€‚ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡è¿›å…¥åˆ° `[istio-mastery]` å­˜å‚¨åº“çš„æ ¹æ–‡ä»¶å¤¹ å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ æ¥éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ç¨‹åº ï¼š

```bash
$ kubectl apply -f resource-manifests/kube
persistentvolumeclaim/sqlite-pvc created
deployment.extensions/sa-feedback created
service/sa-feedback created
deployment.extensions/sa-frontend created
service/sa-frontend created
deployment.extensions/sa-logic created
service/sa-logic created
deployment.extensions/sa-web-app created
service/sa-web-app created
```

åœ¨éƒ¨ç½²çš„æœåŠ¡ä¸­ï¼Œé€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ `kubectl get pods` éªŒè¯podæœ‰ä¸¤ä¸ªå®¹å™¨ï¼ˆserviceå’Œsidecarï¼‰ï¼Œ å¹¶ç¡®ä¿å‡†å¤‡å¥½åï¼Œæˆ‘ä»¬çœ‹åˆ°å€¼â€œ **2/2** â€è¡¨ç¤ºä¸¤ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
$ kubectl get pods
NAME                           READY     STATUS    RESTARTS   AGE
sa-feedback-55f5dc4d9c-c9wfv   2/2       Running   0          12m
sa-frontend-558f8986-hhkj9     2/2       Running   0          12m
sa-logic-568498cb4d-2sjwj      2/2       Running   0          12m
sa-logic-568498cb4d-p4f8c      2/2       Running   0          12m
sa-web-app-599cf47c7c-s7cvd    2/2       Running   0          12m
```

è§†è§‰å‘ˆç°åœ¨å›¾7ä¸­ã€‚

![å›¾7.å…¶ä¸­ä¸€ä¸ªPodä¸­çš„Envoyä»£ç†](https://ws1.sinaimg.cn/large/61411417ly1g0exu2ti9mj209n0dtwf8.jpg)

ç°åœ¨ï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦å…è®¸ä¼ å…¥æµé‡åˆ°è¾¾æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

### å…¥å£ç½‘å…³

å…è®¸æµé‡è¿›å…¥é›†ç¾¤çš„æœ€ä½³åšæ³•æ˜¯é€šè¿‡Istioçš„ **å…¥å£ç½‘å…³** å°†å…¶è‡ªèº«ç½®äºé›†ç¾¤çš„è¾¹ç¼˜ï¼Œå¹¶åœ¨ä¼ å…¥æµé‡ä¸Šå®ç°Istioçš„åŠŸèƒ½ï¼Œå¦‚è·¯ç”±ï¼Œè´Ÿè½½å‡è¡¡ï¼Œå®‰å…¨æ€§å’Œç›‘æ§ã€‚

åœ¨Istioçš„å®‰è£…è¿‡ç¨‹ä¸­ï¼Œ `Ingress Gateway` ç»„ä»¶å’Œåœ¨å¤–éƒ¨å…¬å¼€å®ƒçš„æœåŠ¡å·²å®‰è£…åˆ°é›†ç¾¤ä¸­ã€‚è¦è·å–æœåŠ¡å¤–éƒ¨IPï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ kubectl get svc -n istio-system -l istio=ingressgateway
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP
istio-ingressgateway   LoadBalancer   10.0.132.127   13.93.30.120
```

åœ¨æœ¬æ–‡çš„åç»­éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¿é—®æ­¤IPä¸Šçš„åº”ç”¨ç¨‹åºï¼ˆç§°ä¸ºEXTERNAL\-IPï¼‰ï¼Œä¸ºæ–¹ä¾¿èµ·è§ï¼Œé€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†å…¶ä¿å­˜åœ¨å˜é‡ä¸­ï¼š

```bash
$ EXTERNAL_IP=$(kubectl get svc -n istio-system \
  -l app=istio-ingressgateway \
  -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}')

```

å¦‚æœæ‚¨åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ­¤IPå¹¶ä¸”æ‚¨å°†æ”¶åˆ°æœåŠ¡ä¸å¯ç”¨é”™è¯¯ï¼Œåˆ™ **é»˜è®¤æƒ…å†µä¸‹Istioå°†é˜»æ­¢ä»»ä½•ä¼ å…¥æµé‡**ï¼Œ ç›´åˆ°æˆ‘ä»¬å®šä¹‰ç½‘å…³ã€‚

### ç½‘å…³èµ„æº

ç½‘å…³æ˜¯åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸­å®‰è£…Istioæ—¶å®šä¹‰çš„Kubernetesè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼Œä½¿æˆ‘ä»¬èƒ½å¤ŸæŒ‡å®šæˆ‘ä»¬å¸Œæœ›å…è®¸ä¼ å…¥æµé‡çš„ç«¯å£ï¼Œåè®®å’Œä¸»æœºã€‚

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å…è®¸æ‰€æœ‰ä¸»æœºåœ¨ç«¯å£80ä¸Šä½¿ç”¨HTTPæµé‡ã€‚è¾¾åˆ°ä»¥ä¸‹å®šä¹‰ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: http-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"

```

é™¤äº†é€‰æ‹©å™¨`istioï¼šingressgateway`ä¹‹å¤–ï¼Œæ‰€æœ‰é…ç½®éƒ½æ˜¯ä¸éœ€è¦è¯´æ˜çš„ã€‚ä½¿ç”¨æ­¤é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šåº”ç”¨é…ç½®çš„Ingress Gatewayï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒæ˜¯å®‰è£…åœ¨Istioè®¾ç½®ä¸Šçš„é»˜è®¤å…¥å£ç½‘å…³æ§åˆ¶å™¨ã€‚

é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åº”ç”¨é…ç½®ï¼š

```bash
$ kubectl apply -f resource-manifests/istio/http-gateway.yaml
gateway.networking.istio.io/http-gateway created

```

ç½‘å…³ç°åœ¨å…è®¸åœ¨ç«¯å£80ä¸­è¿›è¡Œè®¿é—®ï¼Œä½†å®ƒä¸çŸ¥é“åœ¨ä½•å¤„è·¯ç”±è¯·æ±‚ã€‚è¿™éœ€è¦ä½¿ç”¨**Virtual Service**æ¥å®ç°ã€‚

### VirtualServiceèµ„æº

VirtualServiceæŒ‡ç¤ºIngress Gatewayå¦‚ä½•è·¯ç”±å…è®¸è¿›å…¥é›†ç¾¤çš„è¯·æ±‚ã€‚

å¯¹äºæˆ‘ä»¬åº¦è¿‡å³å°†åˆ°æ¥çš„åº”ç”¨ç¨‹åºè¯·æ±‚ **HTTPç½‘å…³** å¿…é¡»è¢«è·¯ç”±åˆ° `sa-frontend`ï¼Œ`sa-web-app` å’Œ`sa-feedback` æœåŠ¡ï¼ˆå‡ºäº†å¦‚å›¾8ï¼‰ã€‚

![å›¾8.ä½¿ç”¨VirtualServicesé…ç½®çš„è·¯ç”±](https://ws1.sinaimg.cn/large/61411417ly1g0exu2n39aj20m80gk75x.jpg)

è®©æˆ‘ä»¬åˆ†è§£ä»¥ä¸‹è·¯ç”±åˆ°SA\-Frontendçš„è¯·æ±‚ï¼š

- `**/**` åº”å°†**ç²¾ç¡®è·¯å¾„** è·¯ç”±åˆ°SA\-Frontendä»¥è·å–Index.html
- `**/static/***` åº”å°†**å‰ç¼€è·¯å¾„** è·¯ç”±åˆ°SA\-Frontendä»¥è·å–å‰ç«¯æ‰€éœ€çš„ä»»ä½•é™æ€æ–‡ä»¶ï¼Œå¦‚Csså’ŒJavaScriptæ–‡ä»¶ã€‚
- **åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„è·¯å¾„**`'^.*\.(ico|png|jpg)$'` åº”è¯¥è·¯ç”±åˆ°SA\-Frontendï¼Œæˆ‘ä»¬åº”è¯¥æŠŠå›¾åƒèµ„æºè·¯ç”±åˆ°å‰ç«¯ã€‚

è¿™æ˜¯é€šè¿‡ä»¥ä¸‹é…ç½®å®ç°çš„ï¼š

```yaml
kind: VirtualService
metadata:
  name: sa-external-services
spec:
  hosts:
  - "*"
  gateways:
  - http-gateway                      # 1
  http:
  - match:
    - uri:
        exact: /
    - uri:
        exact: /callback
    - uri:
        prefix: /static
    - uri:
        regex: '^.*\.(ico|png|jpg)$'
    route:
    - destination:
        host: sa-frontend             # 2
        port:
          number: 80

```

è¿™é‡Œçš„é‡ç‚¹æ˜¯ï¼š

1. æ­¤VirtualServiceé€‚ç”¨äºé€šè¿‡**httpç½‘å…³** å‘å‡ºçš„è¯·æ±‚
2. Destinationå®šä¹‰è¯·æ±‚è·¯ç”±åˆ°çš„æœåŠ¡ã€‚

**æ³¨æ„**ï¼š ä¸Šé¢çš„é…ç½®ä½äºæ–‡ä»¶ä¸­ `sa-virtualservice-external.yaml`ï¼Œå®ƒè¿˜åŒ…å«ç”¨äºè·¯ç”±åˆ°SA\-WebAppå’ŒSA\-Feedbackçš„é…ç½®ï¼Œä½†ä¸ºç®€æ´èµ·è§ï¼Œå·²ç¼©çŸ­ã€‚

é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åº”ç”¨VirtualServiceï¼š

```bash
$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml
virtualservice.networking.istio.io/sa-external-services created

```

**æ³¨æ„**ï¼š å½“æˆ‘ä»¬åº”ç”¨Istioèµ„æºæ—¶ï¼ŒKubernetes APIæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªç”±Istioæ§åˆ¶å¹³é¢æ¥æ”¶çš„äº‹ä»¶ï¼Œç„¶åå°†æ–°é…ç½®åº”ç”¨äºæ¯ä¸ªpodçš„Envoyä»£ç†ã€‚Ingress Gatewayæ§åˆ¶å™¨æ˜¯å¦ä¸€ä¸ªç”±æ§åˆ¶å¹³é¢é…ç½®çš„Envoyï¼Œå¦‚å›¾9æ‰€ç¤ºã€‚

![å›¾9.é…ç½® **Istio\-IngressGateway** æ¥è·¯ç”±è¯·æ±‚](https://ws1.sinaimg.cn/large/61411417ly1g0exu1t95sj20m80i2jt1.jpg)

ç°åœ¨å¯ä»¥è®¿é—®Sentiment Analysisåº”ç”¨ç¨‹åºäº† `http://{EXTERNAL-IP}/` ã€‚å¦‚æœæ‚¨è·å¾—Not FoundçŠ¶æ€ï¼Œè¯·ä¸è¦æ‹…å¿ƒ *æœ‰æ—¶éœ€è¦é…ç½®ç”Ÿæ•ˆæ‰èƒ½æ›´æ–°envoyçš„ç¼“å­˜* ã€‚

åœ¨è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ä¹‹å‰ï¼Œè¯·ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºç”Ÿæˆä¸€äº›æµé‡ã€‚

### Kiali \- å¯è§‚å¯Ÿæ€§

è¦è®¿é—®Kialiçš„Admin UIï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ kubectl port-forward \
    $(kubectl get pod -n istio-system -l app=kiali \
    -o jsonpath='{.items[0].metadata.name}') \
    -n istio-system 20001
```

å¹¶ [http://localhost:20001/](http://localhost:20001/) ä½¿ç”¨â€œadminâ€ï¼ˆä¸å«å¼•å·ï¼‰ä¸ºç”¨æˆ·å’Œå¯†ç æ‰“å¼€ç™»å½•ã€‚æœ‰å¾ˆå¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æ£€æŸ¥Istioç»„ä»¶çš„é…ç½®ï¼Œæ ¹æ®æ‹¦æˆªç½‘ç»œè¯·æ±‚å’Œå›ç­”æ”¶é›†çš„ä¿¡æ¯å¯è§†åŒ–æœåŠ¡ï¼Œâ€œè°åœ¨è°ƒç”¨è°ï¼Ÿâ€ï¼Œâ€œå“ªä¸ªç‰ˆæœ¬çš„æœåŠ¡æœ‰æ•…éšœï¼Ÿâ€ç­‰ç­‰ï¼ŒèŠ±ä¸€äº›æ—¶é—´æ£€éªŒKialiçš„åŠŸèƒ½ï¼Œç„¶åå†è½¬åˆ°ä¸‹ä¸€èŠ‚ï¼Œç”¨Grafanaå¯è§†åŒ–æŒ‡æ ‡ï¼

![å›¾10. Kiali \- æœåŠ¡å¯è§‚å¯Ÿæ€§](https://ws1.sinaimg.cn/large/61411417ly1g0exu28njyj20m80c7mye.jpg)

### Grafana \- åº¦é‡å¯è§†åŒ–

ä½¿ç”¨Grafanaå°†Istioæ”¶é›†çš„æŒ‡æ ‡åˆ’åˆ†ä¸ºPrometheuså’ŒVisualizedã€‚è¦è®¿é—®Grafanaçš„Admin UIï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¹¶æ‰“å¼€[http://localhost:3000](http://localhost:3000)ã€‚

```bash
$ kubectl -n istio-system port-forward \
    $(kubectl -n istio-system get pod -l app=grafana \
    -o jsonpath={.items[0].metadata.name}) 3000
```

åœ¨å·¦ä¸Šè§’å•å‡»èœå•**Home** å¹¶é€‰æ‹© **Istio Service Dashboard** å¹¶åœ¨å·¦ä¸Šè§’é€‰æ‹©ä»¥**sa\-web\-app**å¼€å¤´çš„æœåŠ¡ï¼Œæ‚¨å°†çœ‹åˆ°æ”¶é›†çš„æŒ‡æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://ws1.sinaimg.cn/large/61411417ly1g0exu1z8vbj20m80cnabv.jpg)

æˆ‘çš„å¦ˆå‘€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•æ•°æ®çš„è§†å›¾ï¼Œç®¡ç†å±‚æ°¸è¿œä¸ä¼šèµåŒè¿™ä¸€ç‚¹ã€‚è®©æˆ‘ä»¬é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä¸€äº›è´Ÿè½½ï¼š

```bash
$ while true; do \
    curl -i http://$EXTERNAL_IP/sentiment \
    -H "Content-type: application/json" \
    -d '{"sentence": "I love yogobella"}'; \
    sleep .8; done
```

ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰æ›´æ¼‚äº®çš„å›¾è¡¨ï¼Œæ­¤å¤–ï¼Œæˆ‘ä»¬æ‹¥æœ‰Prometheusç”¨äºç›‘æ§å’ŒGrafanaç”¨äºå¯è§†åŒ–æŒ‡æ ‡è¿™äº›ä»¤äººæƒŠè®¶çš„å·¥å…·ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿéšæ—¶äº†è§£æœåŠ¡çš„æ€§èƒ½ï¼Œå¥åº·çŠ¶å†µï¼Œå‡çº§æˆ–é™çº§ï¼

æœ€åï¼Œæˆ‘ä»¬å°†ç ”ç©¶æ•´ä¸ªæœåŠ¡ä¸­çš„è·Ÿè¸ªè¯·æ±‚ã€‚

### Jaeger \- è¿½è¸ª

æˆ‘ä»¬éœ€è¦è·Ÿè¸ªï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æ‹¥æœ‰çš„æœåŠ¡è¶Šå¤šï¼Œå°±è¶Šéš¾æ‰¾å‡ºå¤±è´¥çš„åŸå› ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢å›¾ç‰‡ä¸­çš„ç®€å•æ¡ˆä¾‹ï¼š

![å›¾12.é€šå¸¸éšæœºå¤±è´¥çš„è¯·æ±‚](https://ws1.sinaimg.cn/large/61411417ly1g0exu2ht7hj20m804fjrw.jpg)

è¯·æ±‚è¿›å…¥ï¼Œå¤±è´¥ï¼Œ*åŸå› æ˜¯ä»€ä¹ˆ*ï¼Ÿ*ç¬¬ä¸€æ¬¡æœåŠ¡*ï¼Ÿ*è¿˜æ˜¯ç¬¬äºŒä¸ª*ï¼Ÿä¸¤è€…éƒ½æœ‰ä¾‹å¤–æƒ…å†µï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªæ—¥å¿—ã€‚ä½ å‘ç°è‡ªå·±è¿™ä¹ˆåšäº†å¤šå°‘æ¬¡ï¼Ÿ æˆ‘ä»¬çš„å·¥ä½œæ›´åƒæ˜¯è½¯ä»¶ä¾¦æ¢è€Œä¸æ˜¯å¼€å‘äººå‘˜ã€‚

è¿™æ˜¯å¾®æœåŠ¡ä¸­çš„ä¸€ä¸ªæ™®éé—®é¢˜ï¼Œå®ƒä½¿ç”¨åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿè§£å†³ï¼Œå…¶ä¸­æœåŠ¡å°†å”¯ä¸€çš„headerç›¸äº’ä¼ é€’ï¼Œç„¶åå°†æ­¤ä¿¡æ¯è½¬å‘åˆ°è¯·æ±‚è·Ÿè¸ªæ”¾åœ¨ä¸€èµ·çš„åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿã€‚ä¸€ä¸ªä¾‹å­å¦‚å›¾13æ‰€ç¤ºã€‚

![å›¾13.ç”¨äºæ ‡è¯†è¯·æ±‚èŒƒå›´çš„TraceId](https://ws1.sinaimg.cn/large/61411417ly1g0exu2k4zsj20rs06uwfz.jpg)

Istioä½¿ç”¨Jaeger Tracerå®ç°OpenTracing APIï¼Œè¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹äºä¾›åº”å•†çš„æ¡†æ¶ã€‚è¦è®¿é—®Jaegers UIï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ kubectl port-forward -n istio-system \
    $(kubectl get pod -n istio-system -l app=jaeger \
    -o jsonpath='{.items[0].metadata.name}') 16686

```

ç„¶ååœ¨ [http://localhost:16686](http://localhost:16686/) ä¸­æ‰“å¼€UIï¼Œé€‰æ‹© **sa\-web\-app** æœåŠ¡ï¼Œ *å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸­æœªæ˜¾ç¤ºè¯¥*æœåŠ¡ï¼Œ*åˆ™åœ¨é¡µé¢ä¸Šç”Ÿæˆä¸€äº›æ´»åŠ¨å¹¶ç‚¹å‡»åˆ·æ–°* ã€‚éšåå•å‡»è¯¥æŒ‰é’® **æŸ¥æ‰¾ç—•è¿¹**ï¼Œ è¿™æ˜¾ç¤ºæœ€è¿‘çš„ç—•è¿¹ï¼Œé€‰æ‹©ä»»ä½•å’Œæ‰€æœ‰çš„ç—•è¿¹çš„è¯¦ç»†åˆ†ç±»å°†ä¼šæ˜¾ç¤º ï¼Œå¦‚å›¾14æ‰€ç¤ºã€‚

![å›¾14. Jaeger \- è¯·æ±‚è·Ÿè¸ª](https://ws1.sinaimg.cn/large/61411417ly1g0exu1ca17j20rs0bsgnr.jpg)

è·Ÿè¸ªæ˜¾ç¤ºï¼š

1. è¯·æ±‚æ¥åˆ° **istio\-ingressgateway** ï¼ˆå®ƒæ˜¯ç¬¬ä¸€æ¬¡ä¸å…¶ä¸­ä¸€ä¸ªæœåŠ¡è”ç³»ï¼Œå› æ­¤å¯¹äºç”Ÿæˆè·Ÿè¸ªIDçš„è¯·æ±‚ï¼‰ç„¶åç½‘å…³å°†è¯·æ±‚è½¬å‘ç»™ `sa-web-app` æœåŠ¡ã€‚
2. åœ¨ `sa-web-app` æœåŠ¡ä¸­ï¼Œè¯·æ±‚ç”±Envoysidecaræ‹¾å–å¹¶åˆ›å»ºä¸€ä¸ªspanï¼ˆè¿™å°±æ˜¯æˆ‘ä»¬åœ¨è·Ÿè¸ªä¸­çœ‹åˆ°å®ƒçš„åŸå› ï¼‰å¹¶è½¬å‘åˆ° `sa-web-app` å®¹å™¨å®ä¾‹ã€‚
3. è¿™é‡Œæ–¹æ³• **sentimentAnalysis** å¤„ç†è¯·æ±‚ã€‚è¿™äº›è·Ÿè¸ªç”±åº”ç”¨ç¨‹åºç”Ÿæˆï¼Œè¿™æ„å‘³ç€éœ€è¦æ›´æ”¹ä»£ç ï¼‰ã€‚
4. ä»POSTè¯·æ±‚`sa-logic`å¼€å§‹çš„ä½ç½®ã€‚è·Ÿè¸ªIDéœ€è¦`sa-web-app`ä¼ é€’  ã€‚

5\. ...

**æ³¨æ„** ï¼šåœ¨ç¬¬4ç‚¹ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦è·å–Istioç”Ÿæˆçš„headerï¼Œå¹¶åœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶å°†å…¶ä¼ é€’ä¸‹æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![å›¾15.(A)Istioä¼ é€’å¤´ï¼Œ **(B)æœåŠ¡ä¼ é€’å¤´**](https://ws1.sinaimg.cn/large/61411417ly1g0exu1odduj20m8055q3r.jpg)

Istioåšä¸»è¦çš„ç¹é‡å·¥ä½œï¼Œå› ä¸ºå®ƒåœ¨ä¼ å…¥çš„è¯·æ±‚ä¸Šç”Ÿæˆheaderï¼Œåœ¨æ¯ä¸ªsidecarä¸Šåˆ›å»ºæ–°çš„spanï¼Œä¼ é€’å®ƒä»¬ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æˆ‘ä»¬çš„æœåŠ¡ä¼ é€’headerï¼Œæˆ‘ä»¬å°†å¤±å»è¯·æ±‚çš„å®Œæ•´è·Ÿè¸ªã€‚

è¦ä¼ é€’çš„headeræ˜¯ï¼š

```bash
x-request-id
x-b3-traceid
x-b3-spanid
x-b3-parentspanid
x-b3-sampled
x-b3-flags
x-ot-span-context
```

å°½ç®¡è¿™æ˜¯ä¸€é¡¹ç®€å•çš„ä»»åŠ¡ï¼Œä½†å·²ç»æœ‰[è®¸å¤šåº“](https://github.com/opentracing-contrib) å¯ä»¥ç®€åŒ–è¿™ä¸€è¿‡ç¨‹ï¼Œä¾‹å¦‚åœ¨ `sa-web-app`æœåŠ¡ä¸­ï¼Œ **RestTemplate** å®¢æˆ·ç«¯é€šè¿‡ç®€å•åœ°[ä¾èµ–é¡¹ä¸­](https://github.com/rinormaloku/istio-mastery/blob/master/sa-webapp/pom.xml#L36-L47) æ·»åŠ Jaegerå’ŒOpenTracingåº“æ¥ä¼ é€’header ã€‚

*æ³¨æ„ï¼šSentiment Analysisåº”ç”¨ç¨‹åºå±•ç¤ºäº†Flaskï¼ŒSpringå’ŒASP.NET Coreçš„å®ç°ã€‚*

ç°åœ¨ï¼Œåœ¨è°ƒæŸ¥æˆ‘ä»¬å¼€ç®±å³ç”¨ï¼ˆæˆ–éƒ¨åˆ†å¼€ç®±å³ç”¨ï¼‰ä¹‹åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™é‡Œçš„ä¸»é¢˜ï¼Œç»†ç²’åº¦è·¯ç”±ï¼Œç®¡ç†ç½‘ç»œæµé‡ï¼Œå®‰å…¨æ€§ç­‰ç­‰ï¼

### æµé‡ç®¡ç†

ä½¿ç”¨Envoyçš„Istioä¸ºæ‚¨çš„é›†ç¾¤æä¾›äº†è®¸å¤šæ–°åŠŸèƒ½ï¼Œä»è€Œå®ç°ï¼š

- **åŠ¨æ€è¯·æ±‚è·¯ç”±** ï¼šCanaryéƒ¨ç½²ï¼ŒA/Bæµ‹è¯•ï¼Œ
- **è´Ÿè½½å‡è¡¡ï¼š** ç®€å•å’Œä¸€è‡´çš„å“ˆå¸Œå¹³è¡¡ï¼Œ
- **æ•…éšœæ¢å¤** ï¼šè¶…æ—¶ï¼Œé‡è¯•ï¼Œç†”æ–­å™¨ï¼Œ
- **æ•…éšœæ³¨å…¥** ï¼šå»¶è¿Ÿï¼Œä¸­æ­¢è¯·æ±‚ç­‰

åœ¨æœ¬æ–‡çš„åºåˆ—ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å±•ç¤ºè¿™äº›åŠŸèƒ½ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­ä»‹ç»ä¸€äº›æ–°æ¦‚å¿µã€‚æˆ‘ä»¬å°†ç ”ç©¶çš„ç¬¬ä¸€ä¸ªæ¦‚å¿µæ˜¯DestinationRulesï¼Œå¹¶ä½¿ç”¨é‚£äº›æˆ‘ä»¬å°†å¯ç”¨A/Bæµ‹è¯•çš„æ¦‚å¿µã€‚

### A/Bæµ‹è¯• \- å®è·µä¸­çš„ç›®çš„åœ°è§„åˆ™

å½“æˆ‘ä»¬æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºï¼ˆé€šå¸¸ç‰ˆæœ¬è§†è§‰ä¸Šæœ‰æ‰€ä¸åŒï¼‰æ—¶ä½¿ç”¨A/Bæµ‹è¯•ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸æ˜¯100ï¼…è‚¯å®šä¼šå¢åŠ ç”¨æˆ·äº¤äº’ï¼Œå› æ­¤æˆ‘ä»¬åŒæ—¶å°è¯•ä¸¤ä¸ªç‰ˆæœ¬å¹¶æ”¶é›†æŒ‡æ ‡ã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥éƒ¨ç½²æ¼”ç¤ºA/Bæµ‹è¯•æ‰€éœ€çš„å‰ç«¯çš„ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼š

```bash
$ kubectl apply -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml
deployment.extensions/sa-frontend-green created

```

ç»¿è‰²ç‰ˆæœ¬çš„éƒ¨ç½²æ¸…å•æœ‰ä¸¤ç‚¹ä¸åŒï¼š

1. è¯¥imageåŸºäºä¸åŒçš„æ ‡ç­¾ï¼š `istio-green` 
2. podæ ‡æœ‰ `version: green` ã€‚

è€Œä½œä¸ºåŒæ–¹éƒ¨ç½²åœ¨æ ‡ç­¾ `app: sa-frontend` é€šè¿‡è™šæ‹ŸæœåŠ¡è·¯ç”±çš„è¯·æ±‚ `sa-external-services`  çš„æœåŠ¡ `sa-frontend` ä¼šè¢«è½¬å‘åˆ°æ‰€æœ‰çš„å®ä¾‹ï¼Œå¹¶å°†äºè´Ÿè½½é‡‡ç”¨å¾ªç¯ç®—æ³•ï¼Œè¿™å°†å¯¼è‡´åœ¨å›¾16ä¸­æå‡ºçš„è´Ÿè½½å‡è¡¡é—®é¢˜ã€‚

![å›¾16.æ‰¾ä¸åˆ°è¯·æ±‚çš„æ–‡ä»¶](https://ws1.sinaimg.cn/large/61411417ly1g0exu30v6lj20m80do761.jpg)

æ‰¾ä¸åˆ°è¿™äº›æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬åœ¨åº”ç”¨ç¨‹åºçš„ä¸åŒç‰ˆæœ¬ä¸­çš„å‘½åæ–¹å¼ä¸åŒã€‚è®©æˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼š

```bash
$ curl --silent http://$EXTERNAL_IP/ | tr '"' '\n' | grep main
/static/css/main.c7071b22.css
/static/js/main.059f8e9c.js
$ curl --silent http://$EXTERNAL_IP/ | tr '"' '\n' | grep main
/static/css/main.f87cd8c9.css
/static/js/main.f7659dbb.js

```

è¿™æ„å‘³ç€è¯·æ±‚ä¸€ä¸ªç‰ˆæœ¬çš„é™æ€æ–‡ä»¶çš„`index.html`å¯ä»¥è¢«è´Ÿè½½å‡è¡¡åˆ°æä¾›å¦ä¸€ä¸ªç‰ˆæœ¬çš„podï¼Œå…¶ä¸­å¯ä»¥ç†è§£çš„æ˜¯å…¶ä»–æ–‡ä»¶ä¸å­˜åœ¨ã€‚

è¿™æ„å‘³ç€ï¼Œä¸ºäº†è®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥é™åˆ¶â€œä¸ºindex.htmlæœåŠ¡çš„åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ï¼Œå¿…é¡»ä¸ºåç»­è¯·æ±‚æä¾›æœåŠ¡â€ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨Consistent Hash Loadbalancingæ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¿™ **æ˜¯** ä½¿ç”¨é¢„å®šä¹‰å±æ€§ï¼ˆä¾‹å¦‚HTTP headerï¼‰**å°†æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘åˆ°åŒä¸€åç«¯å®ä¾‹çš„è¿‡ç¨‹**ã€‚ç”± DestionatioRulesæä¾›ã€‚

### DestinationRules

åœ¨ **VirtualService** å°†è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„æœåŠ¡ä¹‹åï¼Œç„¶åä½¿ç”¨ **DestinationRules**ï¼Œ æˆ‘ä»¬å¯ä»¥æŒ‡å®šé€‚ç”¨äºæ­¤æœåŠ¡å®ä¾‹çš„æµé‡çš„ç­–ç•¥ï¼Œå¦‚å›¾17æ‰€ç¤ºã€‚

![å›¾17.ä½¿ç”¨Istioèµ„æºçš„æµé‡ç®¡ç†](https://ws1.sinaimg.cn/large/61411417ly1g0exu2yjsuj20rs09e75i.jpg)

**æ³¨æ„**ï¼š å›¾17ä»¥æ˜“äºç†è§£çš„æ–¹å¼å¯è§†åŒ–Istioèµ„æºå¦‚ä½•å½±å“ç½‘ç»œæµé‡ã€‚ä½†æ˜¯ï¼Œå‡†ç¡®åœ°è¯´ï¼Œå†³å®šå°†è¯·æ±‚è½¬å‘åˆ°å“ªä¸ªå®ä¾‹æ˜¯ç”±CRDé…ç½®çš„Ingress Gatewayçš„Envoyåšå‡ºçš„ã€‚

ä½¿ç”¨ç›®æ ‡è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å°†è´Ÿè½½å‡è¡¡é…ç½®ä¸ºå…·æœ‰ä¸€è‡´æ€§å“ˆå¸Œï¼Œå¹¶ç¡®ä¿åŒä¸€ç”¨æˆ·ç”±åŒä¸€æœåŠ¡å®ä¾‹å“åº”ã€‚é€šè¿‡ä»¥ä¸‹é…ç½®å®ç°ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: sa-frontend
spec:
  host: sa-frontend
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: version   # 1
```

1. æ ¹æ®â€œversionâ€æ ‡å¤´çš„å†…å®¹ç”Ÿæˆä¸€è‡´çš„å“ˆå¸Œã€‚

é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åº”ç”¨é…ç½®å¹¶å°è¯•ä¸€ä¸‹ï¼

```bash
$ kubectl apply -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml
destinationrule.networking.istio.io/sa-frontend created
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¹¶éªŒè¯åœ¨æŒ‡å®šç‰ˆæœ¬headeræ—¶æ˜¯å¦è·å¾—ç›¸åŒçš„æ–‡ä»¶ï¼š

```bash
$ curl --silent -H "version: yogo" http://$EXTERNAL_IP/ | tr '"' '\n' | grep main
```

**æ³¨æ„**ï¼š ä¸ºäº†æ–¹ä¾¿åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œæµ‹è¯•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ [Chromeæ‰©å±•ç¨‹åº](https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj) å‘ç‰ˆæœ¬headeræ·»åŠ ä¸åŒçš„å€¼ï¼Œã€‚

DestinationRuleså…·æœ‰æ›´å¤šLoadBalancingåŠŸèƒ½ï¼Œæ‰€æœ‰è¯¦ç»†ä¿¡æ¯éƒ½å¯ä»¥æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://preliminary.istio.io/docs/reference/config/istio.networking.v1alpha3.html#LoadBalancerSettings) ã€‚

åœ¨ç»§ç»­æ›´è¯¦ç»†åœ°æ¢ç´¢VirtualServiceä¹‹å‰ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ é™¤åº”ç”¨ç¨‹åºçš„ç»¿è‰²ç‰ˆæœ¬å’Œç›®æ ‡è§„åˆ™ï¼š

```bash
$ kubectl delete -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml
deployment.extensions "sa-frontend-green" deleted
$ kubectl delete -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml
destinationrule.networking.istio.io â€œsa-frontendâ€ deleted
```

### é•œåƒæœåŠ¡ - å®è·µä¸­çš„è™šæ‹ŸæœåŠ¡

å½“æˆ‘ä»¬æƒ³è¦æµ‹è¯•ç”Ÿäº§ä¸­çš„æ›´æ”¹ä½†ä¸å½±å“æœ€ç»ˆç”¨æˆ·æ—¶ï¼Œä¼šä½¿ç”¨å½±å­æˆ–é•œåƒï¼Œå› æ­¤æˆ‘ä»¬å°†è¯·æ±‚é•œåƒåˆ°å…·æœ‰æ›´æ”¹å¹¶è¯„ä¼°å®ƒçš„ç¬¬äºŒä¸ªå®ä¾‹ä¸­ã€‚ *æ›´ç®€å•çš„æ˜¯ï¼Œå½“ä½ çš„ä¸€ä¸ªåŒäº‹é€‰æ‹©æœ€å…³é”®çš„é—®é¢˜å¹¶åˆ¶ä½œä¸€ä¸ªè¶…å¤§çš„åˆå¹¶è¯·æ±‚ï¼Œå¹¶ä¸”æ²¡äººèƒ½çœŸæ­£å®¡æŸ¥ã€‚*

è¦æµ‹è¯•æ­¤åŠŸèƒ½ï¼Œå¯ä»¥ é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ åˆ›å»ºSA\-Logicçš„ç¬¬äºŒä¸ªå®ä¾‹ï¼ˆ *è¿™æ˜¯buggyçš„* ï¼‰ï¼š

```bash
$ kubectl apply -f resource-manifests/kube/shadowing/sa-logic-service-buggy.yaml
deployment.extensions/sa-logic-buggy created
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¹¶éªŒè¯æ‰€æœ‰å®ä¾‹éƒ½æ ‡æœ‰ç›¸åº”çš„ç‰ˆæœ¬ï¼Œå¦å¤–è¿˜æœ‰`app=sa-logic`æ ‡è®°ï¼š

```bash
$ kubectl get pods -l app=sa-logic --show-labels
NAME                              READY   LABELS
sa-logic-568498cb4d-2sjwj         2/2     app=sa-logic,version=v1
sa-logic-568498cb4d-p4f8c         2/2     app=sa-logic,version=v1
sa-logic-buggy-76dff55847-2fl66   2/2     app=sa-logic,version=v2
sa-logic-buggy-76dff55847-kx8zz   2/2     app=sa-logic,version=v2
```

å½“ `sa-logic` æœåŠ¡ç›®æ ‡podæ ‡è®°ä¸º `app=sa-logic`æ—¶ï¼Œä»»ä½•ä¼ å…¥è¯·æ±‚å°†åœ¨æ‰€æœ‰å®ä¾‹ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå¦‚å›¾18æ‰€ç¤ºã€‚

![å›¾18. Round Robinè´Ÿè½½å‡è¡¡](https://ws1.sinaimg.cn/large/61411417ly1g0exu199gtj20m80f5wgc.jpg)

ä½†æˆ‘ä»¬å¸Œæœ›å°†è¯·æ±‚è·¯ç”±åˆ°ç‰ˆæœ¬ä¸ºv1çš„å®ä¾‹ï¼Œå¹¶é•œåƒåˆ°ç‰ˆæœ¬ä¸ºv2çš„å®ä¾‹ï¼Œå¦‚å›¾19æ‰€ç¤ºã€‚

![å›¾19.è·¯ç”±åˆ°v1å’Œé•œåƒåˆ°v2](https://ws1.sinaimg.cn/large/61411417ly1g0exu2f7y4j20m80b8q3y.jpg)

è¿™æ˜¯ä½¿ç”¨VirtualServiceä¸DestinationRuleç»“åˆå®ç°çš„ï¼Œå…¶ä¸­ç›®æ ‡è§„åˆ™æŒ‡å®šåˆ°ç‰¹å®šå­é›†çš„å­é›†å’ŒVirtualServiceè·¯ç”±ã€‚

### ä½¿ç”¨ç›®æ ‡è§„åˆ™æŒ‡å®šå­é›†

æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹é…ç½®å®šä¹‰å­é›†ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: sa-logic
spec:
  host: sa-logic    # 1
  subsets:
  - name: v1        # 2
    labels:
      version: v1   # 3
  - name: v2
    labels:
      version: v2  
```

1. ä¸»æœºå®šä¹‰æ­¤è§„åˆ™ä»…åœ¨å‘ `sa-logic` æœåŠ¡å‘ç”Ÿè·¯ç”±æ—¶é€‚ç”¨
2. è·¯ç”±åˆ°å­é›†å®ä¾‹æ—¶ä½¿ç”¨çš„å­é›†åç§°ã€‚
3. Labelå®šä¹‰äº†éœ€è¦åŒ¹é…çš„é”®å€¼å¯¹ï¼Œä»¥ä½¿å®ä¾‹æˆä¸ºå­é›†çš„ä¸€éƒ¨åˆ†ã€‚

åº”ç”¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤çš„é…ç½®ï¼š

```bash
$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-destinationrule.yaml
 destinationrule.networking.istio.io/sa-logic created
```

é€šè¿‡å®šä¹‰å­é›†ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å¹¶é…ç½®VirtualServiceä»¥åº”ç”¨äºè¯·æ±‚ `sa-logic` æ‰€åœ¨çš„è¯·æ±‚ï¼š

1. è·¯ç”±åˆ°åä¸ºv1çš„å­é›†ï¼Œ
2. é•œåƒåˆ°åä¸ºv2çš„å­é›†ã€‚

è¿™æ˜¯é€šè¿‡ä»¥ä¸‹æ¸…å•å®ç°çš„ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sa-logic
spec:
  hosts:
    - sa-logic          
  http:
  - route:
    - destination:
        host: sa-logic  
        subset: v1      
    mirror:             
      host: sa-logic     
      subset: v2
```

ç”±äºä¸€åˆ‡é…ç½®éƒ½æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„æ‰§è¡Œï¼š

```bash
$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-shadowing-vs.yaml
virtualservice.networking.istio.io/sa-logic created
```

é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ·»åŠ ä¸€äº›è´Ÿè½½ï¼š

```bash
$ while true; do curl -v http://$EXTERNAL_IP/sentiment \
    -H "Content-type: application/json" \
    -d '{"sentence": "I love yogobella"}'; \
    sleep .8; done
```

æ£€æŸ¥Grafanaä¸­çš„ç»“æœï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰é”™è¯¯çš„ç‰ˆæœ¬å¤§çº¦æœ‰60ï¼…çš„è¯·æ±‚å¤±è´¥ï¼Œä½†æ²¡æœ‰ä¸€ä¸ªå¤±è´¥å½±å“æœ€ç»ˆç”¨æˆ·ï¼Œå› ä¸ºå®ƒä»¬è¢«å½“å‰æ´»åŠ¨çš„æœåŠ¡å“åº”ã€‚

![å›¾20. saé€»è¾‘æœåŠ¡ç‰ˆæœ¬çš„æˆåŠŸç‡](https://ws1.sinaimg.cn/large/61411417ly1g0exu2vr8gj20m80b0t9z.jpg)

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡çœ‹åˆ°åº”ç”¨äºæˆ‘ä»¬æœåŠ¡çš„envoyçš„VirtualServiceï¼Œå½“å¯¹æ­¤ `sa-web-app` æå‡ºè¯·æ±‚æ—¶ï¼Œ `sa-logic`  é€šè¿‡sidecar Envoyï¼Œé€šè¿‡VirtualServiceé…ç½®ä¸ºè·¯ç”±åˆ°å­é›†v1å¹¶é•œåƒåˆ°æœåŠ¡çš„å­é›†v2 `sa-logic` ã€‚

æˆ‘å¯ä»¥çœ‹åˆ°ä½ åœ¨æƒ³â€œDarn man Virtual Serviceså¾ˆç®€å•ï¼â€ï¼Œåœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠå¥å­æ‰©å±•ä¸ºâ€œSimply Amazingï¼â€ã€‚

### é‡‘ä¸é›€éƒ¨ç½²

Canary Deploymentæ˜¯å‘å°‘æ•°ç”¨æˆ·æ¨å‡ºæ–°ç‰ˆæœ¬åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ï¼Œä½œä¸ºéªŒè¯ç¼ºå°‘é—®é¢˜çš„ä¸€ä¸ªæ­¥éª¤ï¼Œç„¶åå‘æ›´å¹¿æ³›çš„å—ä¼—æä¾›æ›´é«˜è´¨é‡çš„å‘å¸ƒä¿è¯ã€‚

æˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨ç›¸åŒçš„buggyå­é›† `sa-logic` æ¥æ¼”ç¤ºcanaryéƒ¨ç½²ã€‚

è®©æˆ‘ä»¬å¤§èƒ†åœ°å¼€å§‹ï¼Œé€šè¿‡åº”ç”¨ä¸‹é¢çš„VirtualServiceï¼Œå°†20ï¼…çš„ç”¨æˆ·å‘é€åˆ°æœ‰ç¼ºé™·çš„ç‰ˆæœ¬ï¼ˆè¿™ä»£è¡¨é‡‘ä¸é›€éƒ¨ç½²ï¼‰å’Œ80ï¼…çš„å¥åº·æœåŠ¡ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sa-logic
spec:
  hosts:
    - sa-logic    
  http:
  - route: 
    - destination: 
        host: sa-logic
        subset: v1
      weight: 80         # 1
    - destination: 
        host: sa-logic
        subset: v2
      weight: 20         # 1
```

1. æƒé‡æŒ‡å®šè¦è½¬å‘åˆ°ç›®æ ‡æˆ–ç›®æ ‡å­é›†çš„è¯·æ±‚çš„ç™¾åˆ†æ¯”ã€‚

`sa-logic` ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ æ›´æ–°ä»¥å‰çš„ è™šæ‹ŸæœåŠ¡é…ç½®ï¼š

```bash
$ kubectl apply -f resource-manifests/istio/canary/sa-logic-subsets-canary-versusyaml
 virtualservice.networking.istio.io/sa-logic configured
```

æˆ‘ä»¬ç«‹å³çœ‹åˆ°æˆ‘ä»¬çš„ä¸€äº›è¯·æ±‚å¤±è´¥äº†ï¼š

```bash
$ while true; do \
   curl -i http://$EXTERNAL_IP/sentiment \
   -H â€œContent-type: application/jsonâ€ \
   -d '{"sentence": "I love yogobella"}' \
   --silent -w "Time: %{time_total}s \t Status: %{http_code}\n" \
   -o /dev/null; sleep .1; done
Time: 0.153075s Status: 200
Time: 0.137581s Status: 200
Time: 0.139345s Status: 200
Time: 30.291806s Status: 500
```

VirtualServiceså¯ç”¨äº†Canary Deploymentsï¼Œé€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å°†æ½œåœ¨çš„æŸå®³å‡å°‘åˆ°äº†20ï¼…çš„ç”¨æˆ·ç¾¤ã€‚æ¼‚äº®ï¼ ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬å¯¹ä»£ç ä¸å®‰å…¨æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Shadowingå’ŒCanary Deploymentsï¼Œæ¢å¥è¯è¯´ï¼Œæ€»æ˜¯å¦‚æ­¤ã€‚ğŸ˜œ

### è¶…æ—¶å’Œé‡è¯•

ä»£ç å¹¶ä¸æ€»æ˜¯é”™è¯¯çš„ã€‚åœ¨â€œ [åˆ†å¸ƒå¼è®¡ç®—çš„8ä¸ªè°¬è¯¯](https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing#The_fallacies) â€åˆ—è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªè°¬è®ºæ˜¯â€œç½‘ç»œå¯é â€ã€‚ç½‘ç»œä¸å¯é ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦è¶…æ—¶å’Œé‡è¯•çš„åŸå› ã€‚

å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨æœ‰ç¼ºé™·çš„ç‰ˆæœ¬ `sa-logic`ï¼Œå…¶ä¸­éšæœºæ•…éšœæ¨¡æ‹Ÿç½‘ç»œçš„ä¸å¯é æ€§ã€‚

æœ‰ç¼ºé™·çš„æœåŠ¡æœ‰ä¸‰åˆ†ä¹‹ä¸€çš„æœºä¼šèŠ±è´¹å¤ªé•¿æ—¶é—´æ¥å“åº”ï¼Œä¸‰åˆ†ä¹‹ä¸€çš„æœºä¼šä»¥å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ç»“æŸï¼Œå…¶ä½™çš„æˆåŠŸå®Œæˆã€‚

ä¸ºäº†ç¼“è§£è¿™äº›é—®é¢˜å¹¶æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. å¦‚æœæœåŠ¡æ—¶é—´è¶…è¿‡8ç§’ï¼Œåˆ™è¶…æ—¶
2. é‡è¯•å¤±è´¥çš„è¯·æ±‚ã€‚

è¿™æ˜¯é€šè¿‡ä»¥ä¸‹èµ„æºå®šä¹‰å®ç°çš„ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sa-logic
spec:
  hosts:
    - sa-logic
  http:
  - route: 
    - destination: 
        host: sa-logic
        subset: v1
      weight: 50
    - destination: 
        host: sa-logic
        subset: v2
      weight: 50
    timeout: 8s           # 1
    retries:
      attempts: 3         # 2
      perTryTimeout: 3s   # 3
```

1. è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ä¸º8ç§’ï¼Œ
2. å®ƒå°è¯•äº†3æ¬¡ï¼Œ
3. å¦‚æœå°è¯•æ—¶é—´è¶…è¿‡3ç§’ï¼Œåˆ™å°è¯•å°†è¯·æ±‚æ ‡è®°ä¸ºå¤±è´¥ã€‚

è¿™æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œå› ä¸ºç”¨æˆ·ä¸ä¼šç­‰å¾…è¶…è¿‡8ç§’ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨å‘ç”Ÿæ•…éšœæ—¶é‡è¯•ä¸‰æ¬¡ï¼Œä»è€Œå¢åŠ äº†å¯¼è‡´å“åº”æˆåŠŸçš„æœºä¼šã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åº”ç”¨æ›´æ–°çš„é…ç½®ï¼š

```bash
$ kubectl apply -f resource-manifests/istio/retries/sa-logic-retries-timeouts-vs.yaml
virtualservice.networking.istio.io/sa-logic configured
```

å¹¶æŸ¥çœ‹Grafanaå›¾è¡¨ï¼Œäº†è§£æˆåŠŸç‡çš„æ”¹å–„æƒ…å†µï¼ˆå¦‚å›¾21æ‰€ç¤ºï¼‰ã€‚

![å›¾21.ä½¿ç”¨è¶…æ—¶å’Œé‡è¯•åçš„æ”¹è¿›](https://ws1.sinaimg.cn/large/61411417ly1g0exu1qjtxj20m80b63zk.jpg)

åœ¨ `sa-logic-buggy` é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ è¿›å…¥ä¸‹ä¸€éƒ¨åˆ†delete å’ŒVirtualService ä¹‹å‰ ï¼š

```bash
$ kubectl delete deployment sa-logic-buggy
deployment.extensions "sa-logic-buggy" deleted
$ kubectl delete virtualservice sa-logic
virtualservice.networking.istio.io â€œsa-logicâ€ deleted
```

### ç†”æ–­å™¨å’Œéš”ç¦»æ¨¡å¼

å¾®æœåŠ¡æ¶æ„ä¸­çš„ä¸¤ä¸ªé‡è¦æ¨¡å¼ï¼Œå¯ä»¥å®ç°æœåŠ¡çš„è‡ªæˆ‘ä¿®å¤ã€‚

è¯¥ **ç†”æ–­å™¨** æ˜¯ç”¨æ¥é˜»æ­¢è¯·æ±‚å°†è§†ä¸ºä¸å¥åº·æœåŠ¡çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä½¿å®ƒèƒ½å¤Ÿæ¢å¤ï¼Œåœ¨æ­¤æœŸé—´å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘åˆ°è¯¥æœåŠ¡çš„å¥åº·æƒ…å†µï¼ˆå¢åŠ æˆåŠŸç‡ï¼‰ã€‚

è¯¥ **éš”ç¦»æ¨¡å¼** æ•´ä¸ªç³»ç»Ÿé™çº§æ¥éš”ç¦»é”™è¯¯ï¼Œé˜²æ­¢é”™è¯¯ä¼ æ’­ï¼Œä¸¾ä¸€ä¸ªéš”ç¦»æ•…éšœä¾‹å­ï¼ŒæœåŠ¡Bå¤„äºæŸåçŠ¶æ€å’Œå…¶å®ƒæœåŠ¡ï¼ˆæœåŠ¡Bçš„å®¢æˆ·ç«¯ï¼‰å‘å‡ºè¯·æ±‚åˆ°æœåŠ¡Bï¼Œè¿™å°†å¯¼è‡´è¯¥å®¢æˆ·ç«¯å°†ä½¿ç”¨äº†è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œå°†æ— æ³•æä¾›å…¶ä»–è¯·æ±‚ï¼ˆå³ä½¿è¿™äº›è¯·æ±‚ä¸æœåŠ¡Bæ— å…³ï¼‰ã€‚

æˆ‘å°†è·³è¿‡è¿™äº›æ¨¡å¼çš„å®ç°ï¼Œå› ä¸ºæ‚¨å¯ä»¥æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£ä¸­çš„å®ç°](https://istio.io/docs/tasks/traffic-management/circuit-breaking/)ï¼Œæˆ‘å¾ˆå…´å¥‹åœ°å±•ç¤ºèº«ä»½éªŒè¯å’Œæˆæƒï¼Œè¿™å°†æ˜¯ä¸‹ä¸€ç¯‡æ–‡ç« çš„ä¸»é¢˜ã€‚

### ç¬¬ä¸€éƒ¨åˆ† \- æ‘˜è¦

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²äº†Istioï¼Œå¹¶ä½¿ç”¨å…¶è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆå¦‚ **ç½‘å…³**ï¼Œ **VirtualServices**ï¼Œ **DestinationRules** åŠå…¶ç»„ä»¶ï¼‰å¯ç”¨äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

- ä½¿ç”¨ **Kiali**ï¼Œé€šè¿‡æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œå®ƒä»¬å¦‚ä½•æ‰§è¡Œï¼Œä»¥åŠå®ƒä»¬å…³ç³»ï¼Œæ¥è§‚å¯Ÿæˆ‘ä»¬çš„æœåŠ¡ ã€‚
- ä½¿ç”¨ **Prometheus** å’Œ **Grafana** è¿›è¡Œæ”¶é›†å’Œå¯è§†åŒ– ã€‚
- è¯·æ±‚ **Jaeger** è·Ÿè¸ª ï¼ˆHunterçš„å¾·è¯­ï¼‰ã€‚
- å¯¹ç½‘ç»œæµé‡è¿›è¡Œå…¨é¢ç»†ç²’åº¦æ§åˆ¶ï¼Œå®ç° **Canary Deployments**ï¼Œ **A/Bæµ‹è¯•å’ŒShadowing** ã€‚
- è½»æ¾å®ç° **é‡è¯•ï¼Œè¶…æ—¶å’ŒCircuitBreakers** ã€‚

æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥åœ¨æ²¡æœ‰ä»£ç æ›´æ”¹æˆ–ä»»ä½•å…¶ä»–ä¾èµ–æ€§çš„æƒ…å†µä¸‹å®ç°ï¼Œä»è€Œä½¿æ‚¨çš„æœåŠ¡ä¿æŒå°å·§ï¼Œæ˜“äºæ“ä½œå’Œç»´æŠ¤

å¯¹äºæ‚¨çš„å¼€å‘å›¢é˜Ÿæ¥è¯´ï¼Œæ¶ˆé™¤è¿™äº›è·¨é¢†åŸŸçš„é—®é¢˜å¹¶å°†å®ƒä»¬é›†ä¸­åˆ°Istioçš„æ§åˆ¶å¹³é¢ï¼Œæ„å‘³ç€æ–°æœåŠ¡å¾ˆå®¹æ˜“å¼•å…¥ï¼Œå®ƒä»¬ä¸ä¼šå ç”¨å¤§é‡èµ„æºï¼Œå› ä¸ºå¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºè§£å†³ä¸šåŠ¡é—®é¢˜ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ²¡æœ‰ä»»ä½•å¼€å‘äººå‘˜æŠ±æ€¨â€œå¿…é¡»è§£å†³æœ‰è¶£çš„ä¸šåŠ¡é—®é¢˜ï¼â€ã€‚

æˆ‘å¾ˆä¹æ„åœ¨ä¸‹é¢çš„è¯„è®ºä¸­å¬åˆ°æ‚¨çš„æƒ³æ³•ï¼Œå¹¶éšæ—¶åœ¨ [Twitter](https://twitter.com/rinormaloku) æˆ–æˆ‘çš„é¡µé¢ [rinormaloku.com](https://rinormaloku.com) ä¸Šä¸æˆ‘ [è”ç³»](https://rinormaloku.com)ï¼Œå¹¶ç»§ç»­å…³æ³¨ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†è§£å†³æœ€åä¸€å±‚è®¤è¯å’Œæˆæƒé—®é¢˜ï¼